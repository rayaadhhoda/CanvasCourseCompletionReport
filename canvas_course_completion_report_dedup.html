<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Canvas Course Completion Dashboard (Students Only)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 1100px;
      margin: 2rem auto;
      padding: 0 1rem 3rem;
      background: #f5f5f7;
    }
    h1 {
      font-size: 1.8rem;
      margin-bottom: 0.3rem;
    }
    h2 {
      margin-top: 2rem;
      font-size: 1.2rem;
    }
    p, li {
      font-size: 0.95rem;
    }
    form {
      border: 1px solid #d4d4d8;
      padding: 1rem;
      border-radius: 0.75rem;
      margin-bottom: 1rem;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
    }
    label {
      display: block;
      margin-top: 0.5rem;
    }
    button {
      margin-top: 1rem;
      padding: 0.45rem 0.9rem;
      cursor: pointer;
      border-radius: 0.5rem;
      border: 1px solid #2563eb;
      background: #2563eb;
      color: #ffffff;
      font-size: 0.95rem;
    }
    button:hover {
      background: #1d4ed8;
    }
    #status {
      margin: 0.5rem 0 1rem;
      font-size: 0.9rem;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.8rem;
      margin-top: 0.75rem;
    }
    .summary-card {
      border-radius: 0.75rem;
      padding: 0.8rem 1rem;
      background: #ffffff;
      border: 1px solid #e4e4e7;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
    }
    .summary-card h3 {
      margin: 0 0 0.35rem;
      font-size: 1rem;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    .summary-card p {
      margin: 0.15rem 0;
      font-size: 0.9rem;
    }
    .badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
      background: #e0f2fe;
      color: #075985;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 0;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #e4e4e7;
      padding: 0.35rem 0.5rem;
      background: #ffffff;
    }
    th {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    #resultsTableWrapper {
      max-height: 420px;
      overflow: auto;
      border-radius: 0.75rem;
      margin-top: 0.5rem;
      border: 1px solid #e4e4e7;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
      background: #ffffff;
    }
    #downloadBtn {
      margin-top: 0.75rem;
      display: none;
      background: #10b981;
      border-color: #059669;
    }
    #downloadBtn:hover {
      background: #059669;
    }
    .status-completed {
      color: #166534;
      font-weight: 600;
    }
    .status-started {
      color: #92400e;
      font-weight: 600;
    }
    .status-notstarted {
      color: #4b5563;
      font-weight: 600;
    }
    .meta-note {
      font-size: 0.8rem;
      color: #4b5563;
      margin-top: 0.3rem;
    }
  </style>
</head>
<body>
  <h1>Canvas Course Completion Dashboard</h1>
  <p>
    Upload one or more <strong>Canvas gradebook CSVs</strong> for any number of courses.
    This dashboard shows completion status for <strong>students only</strong>
    (rows where <code>Role = StudentEnrollment</code>).
  </p>
  <ul>
    <li><strong>Required completion</strong> ignores columns with "optional", "bonus", or "extra" in their name.</li>
    <li><strong>Required status</strong>:
      <ul>
        <li><strong>Completed</strong> – recorded score for every required assignment</li>
        <li><strong>X of Y required assignments completed</strong> – partial progress</li>
        <li><strong>Not started</strong> – no scores on required assignments</li>
      </ul>
    </li>
    <li><strong>Quizzes metric</strong> in the starters row counts students with
      <strong>exactly 3 quiz columns</strong> completed (quiz columns are required
      assignments whose header contains "quiz").
    </li>
  </ul>

  <form id="completionForm">
    <label>
      Canvas CSV files (students only; Teachers/TAs/Designers are ignored):
      <input type="file" id="csvFiles" accept=".csv" multiple required />
    </label>
    <button type="submit">Generate Completion Dashboard</button>
    <div class="meta-note">
      Note: Only rows with <code>Role = StudentEnrollment</code> are included.
      Teachers, TAs, Designers, Observers are excluded.
    </div>
  </form>

  <div id="status"></div>

  <h2>Started-Students Required-Content Summary (Students with ≥1 required assignment)</h2>
  <div id="startedSummary" class="summary-grid"></div>

  <h2>Overall Required-Content Summary (Students Only)</h2>
  <div id="summaryOverall" class="summary-grid"></div>

  <h2>Per-Course Required-Content Summary (by CSV file, Students Only)</h2>
  <div id="summaryPerCourse" class="summary-grid"></div>

  <h2>Detailed Student List (deduplicated by Student ID)</h2>
  <p class="meta-note">
    Each student appears at most once across all uploaded files
    (deduped by SIS User ID → SIS Login ID → Name).<br />
    Status shows required progress, e.g. <em>"3 of 12 required assignments completed"</em>.
    Optional/bonus work is shown in separate columns and does not affect completion.
  </p>
  <div id="resultsTableWrapper">
    <table id="resultsTable" style="display:none;">
      <thead>
        <tr>
          <th>Student</th>
          <th>Student ID (SIS User ID)</th>
          <th>Email / Login (SIS Login ID)</th>
          <th>Course (File)</th>
          <th>Required Status</th>
          <th>Required Assignments with Scores</th>
          <th>Total Required Assignments</th>
          <th>Quiz Assignments with Scores</th>
          <th>Total Quiz Assignments</th>
          <th>Optional/Bonus Assignments with Scores</th>
          <th>Total Optional/Bonus Assignments</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <button id="downloadBtn">Download Report as CSV</button>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const form = document.getElementById("completionForm");
    const fileInput = document.getElementById("csvFiles");
    const statusEl = document.getElementById("status");
    const summaryOverallEl = document.getElementById("summaryOverall");
    const startedSummaryEl = document.getElementById("startedSummary");
    const summaryPerCourseEl = document.getElementById("summaryPerCourse");
    const resultsTable = document.getElementById("resultsTable");
    const resultsTbody = resultsTable.querySelector("tbody");
    const downloadBtn = document.getElementById("downloadBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      summaryOverallEl.innerHTML = "";
      startedSummaryEl.innerHTML = "";
      summaryPerCourseEl.innerHTML = "";
      resultsTbody.innerHTML = "";
      resultsTable.style.display = "none";
      downloadBtn.style.display = "none";

      const files = Array.from(fileInput.files || []);
      if (!files.length) {
        statusEl.textContent = "Please select at least one Canvas CSV file.";
        return;
      }

      statusEl.textContent = "Reading and analyzing CSV files (students only)…";

      try {
        const allStudents = [];

        for (const file of files) {
          const rows = await parseCsvFile(file);
          const studentsForFile = classifyStudentsFromRows(rows, file.name);
          allStudents.push(...studentsForFile);
        }

        if (!allStudents.length) {
          statusEl.textContent = "No student rows (Role = StudentEnrollment) were found in the uploaded files.";
          return;
        }

        const uniqueStudents = dedupeById(allStudents);

        const {
          overallSummary,
          perCourseSummary,
          startedSummary
        } = buildSummaries(uniqueStudents);

        renderOverallSummary(overallSummary);
        renderStartedSummary(startedSummary);
        renderPerCourseSummary(perCourseSummary);
        renderTable(uniqueStudents);
        setupDownload(uniqueStudents);

        statusEl.textContent = "Dashboard generated (students only, deduplicated by ID).";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error processing files: " + err.message;
      }
    });

    function parseCsvFile(file) {
      return new Promise((resolve, reject) => {
        Papa.parse(file, {
          header: true,
          skipEmptyLines: "greedy",
          complete: (results) => {
            if (results.errors && results.errors.length) {
              console.warn("PapaParse errors for", file.name, results.errors);
            }
            resolve(results.data);
          },
          error: (err) => reject(err),
        });
      });
    }

    function prettyCourseName(fileName) {
      let name = fileName.replace(/\.csv$/i, "");
      name = name.replace(/^\d{4}-\d{2}-\d{2}T\d{4}_/, "");
      name = name.replace(/^Grades-/, "");
      return name;
    }

    function classifyStudentsFromRows(rows, fileName) {
      if (!rows.length) return [];

      const keys = Object.keys(rows[0]);
      const idxSection = keys.indexOf("Section");
      const idxAssignCurrent = keys.indexOf("Assignments Current Points");

      if (idxSection === -1 || idxAssignCurrent === -1 || idxAssignCurrent <= idxSection) {
        console.warn(
          `Could not find "Section" and/or "Assignments Current Points" in ${fileName}. Skipping this file.`
        );
        return [];
      }

      let assignmentCols = keys.slice(idxSection + 1, idxAssignCurrent);

      // Required vs optional based on header text
      const requiredCols = assignmentCols.filter(col => {
        const lc = col.toLowerCase();
        return !lc.includes("optional") && !lc.includes("bonus") && !lc.includes("extra");
      });

      const optionalCols = assignmentCols.filter(col => {
        const lc = col.toLowerCase();
        return lc.includes("optional") || lc.includes("bonus") || lc.includes("extra");
      });

      // Among required columns, identify quizzes
      const quizRequiredCols = requiredCols.filter(col =>
        col.toLowerCase().includes("quiz")
      );

      const totalRequired = requiredCols.length;
      const totalOptional = optionalCols.length;
      const totalQuizRequired = quizRequiredCols.length;

      const result = [];

      for (const row of rows) {
        const role = (row["Role"] || "").toString().trim();
        if (role && role !== "StudentEnrollment") continue;

        const studentName = (row["Student"] || "").trim();
        if (!studentName || studentName === "Points Possible") continue;

        let requiredScores = 0;
        for (const col of requiredCols) {
          const raw = row[col];
          if (raw !== undefined && raw !== null && raw !== "") {
            const val = parseFloat(raw);
            if (!isNaN(val)) requiredScores++;
          }
        }

        let optionalScores = 0;
        for (const col of optionalCols) {
          const raw = row[col];
          if (raw !== undefined && raw !== null && raw !== "") {
            const val = parseFloat(raw);
            if (!isNaN(val)) optionalScores++;
          }
        }

        let quizRequiredScores = 0;
        for (const col of quizRequiredCols) {
          const raw = row[col];
          if (raw !== undefined && raw !== null && raw !== "") {
            const val = parseFloat(raw);
            if (!isNaN(val)) quizRequiredScores++;
          }
        }

        let requiredStatus;
        if (totalRequired === 0) {
          requiredStatus = "No required assignments";
        } else if (requiredScores === 0) {
          requiredStatus = "Not started";
        } else if (requiredScores === totalRequired) {
          requiredStatus = "Completed";
        } else {
          requiredStatus = `${requiredScores} of ${totalRequired} required assignments completed`;
        }

        result.push({
          student: studentName,
          sisUserId: row["SIS User ID"] || "",
          sisLoginId: row["SIS Login ID"] || "",
          course: fileName,
          requiredStatus,
          requiredScores,
          totalRequired,
          quizRequiredScores,
          totalQuizRequired,
          optionalScores,
          totalOptional
        });
      }

      return result;
    }

    function dedupeById(students) {
      const seen = new Set();
      const result = [];

      for (const s of students) {
        const id = s.sisUserId || s.sisLoginId || s.student;
        if (!id) {
          result.push(s);
          continue;
        }
        if (!seen.has(id)) {
          seen.add(id);
          result.push(s);
        }
      }
      return result;
    }

    function buildSummaries(students) {
      const overall = {
        total: 0,
        completed: 0,
        startedNotComplete: 0,
        notStarted: 0,
      };
      const perCourse = {};
      const startedSummary = {
        totalStartedRequired: 0,
        completed: 0,
        startedNotComplete: 0,
        startersWithExactly3Quizzes: 0
      };

      for (const s of students) {
        overall.total++;

        if (!perCourse[s.course]) {
          perCourse[s.course] = {
            course: s.course,
            total: 0,
            completed: 0,
            startedNotComplete: 0,
            notStarted: 0,
          };
        }
        const c = perCourse[s.course];
        c.total++;

        // Overall required buckets
        if (s.totalRequired === 0) {
          overall.notStarted++;
          c.notStarted++;
        } else if (s.requiredStatus === "Completed") {
          overall.completed++;
          c.completed++;
        } else if (s.requiredStatus === "Not started") {
          overall.notStarted++;
          c.notStarted++;
        } else {
          overall.startedNotComplete++;
          c.startedNotComplete++;
        }

        // Starters = >0 required scores
        if (s.requiredScores > 0) {
          startedSummary.totalStartedRequired++;
          if (s.requiredStatus === "Completed") {
            startedSummary.completed++;
          } else if (s.requiredStatus !== "No required assignments") {
            startedSummary.startedNotComplete++;
          }

          // Prof metric: exactly 3 quizzes completed
          if (s.quizRequiredScores === 3) {
            startedSummary.startersWithExactly3Quizzes++;
          }
        }
      }

      return {
        overallSummary: overall,
        perCourseSummary: Object.values(perCourse),
        startedSummary
      };
    }

    function renderOverallSummary(overall) {
      const total = overall.total || 1;
      const completedPct = ((overall.completed / total) * 100).toFixed(1);
      const startedPct = ((overall.startedNotComplete / total) * 100).toFixed(1);
      const notStartedPct = ((overall.notStarted / total) * 100).toFixed(1);

      summaryOverallEl.innerHTML = "";

      const cardTotal = document.createElement("div");
      cardTotal.className = "summary-card";
      cardTotal.innerHTML = `
        <h3>Total Unique Students</h3>
        <p><span class="badge">All students</span></p>
        <p><strong>${overall.total}</strong></p>
      `;
      summaryOverallEl.appendChild(cardTotal);

      const cardCompleted = document.createElement("div");
      cardCompleted.className = "summary-card";
      cardCompleted.innerHTML = `
        <h3>Required Content Completed</h3>
        <p><strong>${overall.completed}</strong></p>
        <p>${completedPct}% of students</p>
      `;
      summaryOverallEl.appendChild(cardCompleted);

      const cardStarted = document.createElement("div");
      cardStarted.className = "summary-card";
      cardStarted.innerHTML = `
        <h3>Started but Not Complete</h3>
        <p><strong>${overall.startedNotComplete}</strong></p>
        <p>${startedPct}% of students</p>
      `;
      summaryOverallEl.appendChild(cardStarted);

      const cardNotStarted = document.createElement("div");
      cardNotStarted.className = "summary-card";
      cardNotStarted.innerHTML = `
        <h3>Not Started</h3>
        <p><strong>${overall.notStarted}</strong></p>
        <p>${notStartedPct}% of students</p>
      `;
      summaryOverallEl.appendChild(cardNotStarted);
    }

    function renderStartedSummary(started) {
      const total = started.totalStartedRequired || 1;
      const completedPct = ((started.completed / total) * 100).toFixed(1);
      const startedOnlyPct = ((started.startedNotComplete / total) * 100).toFixed(1);
      const quizzes3Pct = ((started.startersWithExactly3Quizzes / total) * 100).toFixed(1);

      startedSummaryEl.innerHTML = "";

      const cardTotal = document.createElement("div");
      cardTotal.className = "summary-card";
      cardTotal.innerHTML = `
        <h3>Students Who Started Required Content</h3>
        <p><strong>${started.totalStartedRequired}</strong></p>
      `;
      startedSummaryEl.appendChild(cardTotal);

      const cardCompleted = document.createElement("div");
      cardCompleted.className = "summary-card";
      cardCompleted.innerHTML = `
        <h3>Required Content Completed</h3>
        <p><strong>${started.completed}</strong></p>
        <p>${completedPct}% of starters</p>
      `;
      startedSummaryEl.appendChild(cardCompleted);

      const cardStartedOnly = document.createElement("div");
      cardStartedOnly.className = "summary-card";
      cardStartedOnly.innerHTML = `
        <h3>Still In Progress</h3>
        <p><strong>${started.startedNotComplete}</strong></p>
        <p>${startedOnlyPct}% of starters</p>
      `;
      startedSummaryEl.appendChild(cardStartedOnly);

      const cardQuizzes3 = document.createElement("div");
      cardQuizzes3.className = "summary-card";
      cardQuizzes3.innerHTML = `
        <h3>Starters with 3 Quizzes Completed</h3>
        <p><strong>${started.startersWithExactly3Quizzes}</strong></p>
        <p>${quizzes3Pct}% of starters</p>
      `;
      startedSummaryEl.appendChild(cardQuizzes3);
    }

    function renderPerCourseSummary(perCourse) {
      summaryPerCourseEl.innerHTML = "";
      for (const c of perCourse) {
        const total = c.total || 1;
        const completedPct = ((c.completed / total) * 100).toFixed(1);
        const startedPct = ((c.startedNotComplete / total) * 100).toFixed(1);
        const notStartedPct = ((c.notStarted / total) * 100).toFixed(1);

        const card = document.createElement("div");
        card.className = "summary-card";

        card.innerHTML = `
          <h3 title="${c.course}">${prettyCourseName(c.course)}</h3>
          <p><strong>Total students:</strong> ${c.total}</p>
          <p><strong>Required completed:</strong> ${c.completed} (${completedPct}%)</p>
          <p><strong>Started but not complete:</strong> ${c.startedNotComplete} (${startedPct}%)</p>
          <p><strong>Not started:</strong> ${c.notStarted} (${notStartedPct}%)</p>
        `;

        summaryPerCourseEl.appendChild(card);
      }
    }

    function renderTable(students) {
      if (!students.length) {
        resultsTable.style.display = "none";
        return;
      }
      resultsTbody.innerHTML = "";
      for (const s of students) {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = s.student;
        tr.appendChild(tdName);

        const tdId = document.createElement("td");
        tdId.textContent = s.sisUserId;
        tr.appendChild(tdId);

        const tdLogin = document.createElement("td");
        tdLogin.textContent = s.sisLoginId;
        tr.appendChild(tdLogin);

        const tdCourse = document.createElement("td");
        tdCourse.textContent = prettyCourseName(s.course);
        tr.appendChild(tdCourse);

        const tdStatus = document.createElement("td");
        tdStatus.textContent = s.requiredStatus;
        if (s.requiredStatus === "Completed") {
          tdStatus.className = "status-completed";
        } else if (s.requiredStatus === "Not started" || s.requiredStatus === "No required assignments") {
          tdStatus.className = "status-notstarted";
        } else {
          tdStatus.className = "status-started";
        }
        tr.appendChild(tdStatus);

        const tdReqScores = document.createElement("td");
        tdReqScores.textContent = s.requiredScores;
        tr.appendChild(tdReqScores);

        const tdReqTotal = document.createElement("td");
        tdReqTotal.textContent = s.totalRequired;
        tr.appendChild(tdReqTotal);

        const tdQuizScores = document.createElement("td");
        tdQuizScores.textContent = s.quizRequiredScores;
        tr.appendChild(tdQuizScores);

        const tdQuizTotal = document.createElement("td");
        tdQuizTotal.textContent = s.totalQuizRequired;
        tr.appendChild(tdQuizTotal);

        const tdOptScores = document.createElement("td");
        tdOptScores.textContent = s.optionalScores;
        tr.appendChild(tdOptScores);

        const tdOptTotal = document.createElement("td");
        tdOptTotal.textContent = s.totalOptional;
        tr.appendChild(tdOptTotal);

        resultsTbody.appendChild(tr);
      }
      resultsTable.style.display = "table";
    }

    function setupDownload(students) {
      if (!students.length) {
        downloadBtn.style.display = "none";
        return;
      }
      downloadBtn.style.display = "inline-block";

      downloadBtn.onclick = () => {
        const header = [
          "Student",
          "SIS User ID",
          "SIS Login ID",
          "Course (File)",
          "Required Status",
          "Required Assignments with Scores",
          "Total Required Assignments",
          "Quiz Assignments with Scores",
          "Total Quiz Assignments",
          "Optional/Bonus Assignments with Scores",
          "Total Optional/Bonus Assignments"
        ];
        const lines = [header.join(",")];

        for (const s of students) {
          const row = [
            csvEscape(s.student),
            csvEscape(s.sisUserId),
            csvEscape(s.sisLoginId),
            csvEscape(s.course),
            csvEscape(s.requiredStatus),
            csvEscape(s.requiredScores ?? ""),
            csvEscape(s.totalRequired ?? ""),
            csvEscape(s.quizRequiredScores ?? ""),
            csvEscape(s.totalQuizRequired ?? ""),
            csvEscape(s.optionalScores ?? ""),
            csvEscape(s.totalOptional ?? "")
          ];
          lines.push(row.join(","));
        }

        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "canvas_completion_dashboard_students_only.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };
    }

    function csvEscape(value) {
      const str = (value ?? "").toString();
      if (str.includes('"') || str.includes(",") || str.includes("\n")) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }
  </script>
</body>
</html>
